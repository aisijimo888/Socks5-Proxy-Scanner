name: è‡ªåŠ¨æ›´æ–°ä»£ç†æ± 

on:
  schedule:
    # æ¯å¤©è¿è¡Œä¸¤æ¬¡ (00:00 UTC, 12:00 UTC)
    - cron: '0 0,12 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  update-proxies:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
      
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: ç¼“å­˜pipä¾èµ–
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: å®‰è£…ä¾èµ–
        run: |
          pip install -r requirements.txt
      
      - name: è¿è¡Œä»£ç†æ‰«æå™¨
        env:
          DATABASE_PATH: proxies.db
          SCAN_TIMEOUT: 8
          MAX_CONCURRENCY: 100  # æå‡åˆ°100ï¼ˆé€‚åº”Actionsç¯å¢ƒï¼‰
        run: |
          # è¿è¡Œä¸»ç¨‹åºï¼Œå¯ç”¨é»‘åå•åŠŸèƒ½ï¼ˆä¸€æ¬¡å¤±è´¥å³æ‹‰é»‘ï¼Œ7å¤©æ¸…ç†ï¼‰
          python proxy_scanner_enhanced.py --timeout 8 --max-concurrency 100 --output subscribe/proxies.json --enable-blacklist --auto-blacklist --blacklist-threshold 1 --cleanup-days 7
      
      - name: ç”Ÿæˆè®¢é˜…æ–‡ä»¶
        run: |
          echo "ğŸ“¦ ç”Ÿæˆè®¢é˜…æ–‡ä»¶..."
          python subscription_generator.py
          echo "âœ… è®¢é˜…æ–‡ä»¶ç”Ÿæˆå®Œæˆ"
      
      - name: ç”Ÿæˆç»Ÿè®¡æ‘˜è¦
        run: |
          python -c "
          import json
          import os
          from datetime import datetime
          
          try:
              # ä» subscribe ç›®å½•è¯»å–
              if os.path.exists('subscribe/proxies.json'):
                  with open('subscribe/proxies.json', 'r', encoding='utf-8') as f:
                      data = json.load(f)
                      # å¤„ç†æ–°æ ¼å¼ï¼šåŒ…å«metadataçš„åŒ…è£…ç»“æ„
                      if isinstance(data, dict) and 'proxies' in data:
                          proxies = data['proxies']
                      elif isinstance(data, list):
                          proxies = data
                      else:
                          proxies = []
              else:
                  proxies = []
              
              total = len(proxies)
              # ç®€å•çš„å›½å®¶ç»Ÿè®¡
              countries = {}
              for p in proxies:
                  c = p.get('country', 'Unknown')
                  countries[c] = countries.get(c, 0) + 1
              
              # ç”Ÿæˆ Markdown æ‘˜è¦
              summary = f'''
              # ğŸ“Š ä»£ç†æ± æ›´æ–°æ‘˜è¦
              
              **æ›´æ–°æ—¶é—´:** {datetime.now().strftime('%Y-%m-%d %H:%M:%S UTC')}
              
              ## ğŸ“ˆ ç»Ÿè®¡ä¿¡æ¯
              
              | æŒ‡æ ‡ | æ•°å€¼ |
              |------|------|
              | âœ… æ€»ä»£ç†æ•° | {total} |
              | ğŸŒ å›½å®¶æ•°é‡ | {len(countries)} |
              
              ## ğŸŒ å›½å®¶åˆ†å¸ƒ (Top 10)
              
              '''
              
              # æ·»åŠ å›½å®¶åˆ†å¸ƒ
              if countries:
                  sorted_countries = sorted(countries.items(), key=lambda x: x[1], reverse=True)[:10]
                  summary += '| å›½å®¶ | æ•°é‡ |\\n|------|------|\\n'
                  for country, count in sorted_countries:
                      summary += f'| {country} | {count} |\\n'
              else:
                  summary += '*æš‚æ— æ•°æ®*\\n'
              
              summary += '''
              
              ## ğŸ“ è®¢é˜…é“¾æ¥
              
              ç‚¹å‡»ä¸‹æ–¹é“¾æ¥è·å–æœ€æ–°ä»£ç†è®¢é˜…ï¼š
              
              - ğŸ”· [Clash è®¢é˜…](https://raw.githubusercontent.com/${{ github.repository }}/main/subscribe/clash.yaml)
              - ğŸ”¶ [V2Ray è®¢é˜…](https://raw.githubusercontent.com/${{ github.repository }}/main/subscribe/v2ray.json)
              - ğŸ“„ [çº¯æ–‡æœ¬åˆ—è¡¨](https://raw.githubusercontent.com/${{ github.repository }}/main/subscribe/proxies.txt)
              '''
              
              # å†™å…¥åˆ° GitHub Step Summary
              with open(os.environ['GITHUB_STEP_SUMMARY'], 'w', encoding='utf-8') as f:
                  f.write(summary)
              
              print('âœ… Actions æ‘˜è¦å·²ç”Ÿæˆ')
          except Exception as e:
              print(f'âŒ ç”Ÿæˆæ‘˜è¦å¤±è´¥: {e}')
          "
      
      - name: æäº¤æ›´æ–°
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          # æ·»åŠ æ‰€æœ‰ç”Ÿæˆçš„æ–‡ä»¶ï¼ˆæ˜ç¡®æŒ‡å®šæ¯ä¸ªæ–‡ä»¶ç±»å‹ï¼‰
          git add -f subscribe/*.json subscribe/*.txt subscribe/*.csv subscribe/*.yaml subscribe/*.yml proxies.db
          # æ˜¾ç¤ºå°†è¦æäº¤çš„æ–‡ä»¶ï¼ˆè°ƒè¯•ç”¨ï¼‰
          echo "Files to commit:"
          git diff --staged --name-only
          # åªæœ‰åœ¨æœ‰å˜åŒ–æ—¶æ‰æäº¤
          if ! git diff --quiet || ! git diff --staged --quiet; then
            git commit -m "ğŸ”„ è‡ªåŠ¨æ›´æ–°ä»£ç†æ±  $(date +'%Y-%m-%d %H:%M:%S')"
            # æ‹‰å–è¿œç¨‹æ›´æ–°å¹¶æ¨é€ï¼ˆé¿å…å†²çªï¼‰
            git pull --rebase origin main || true
            git push
            echo "âœ… æ–‡ä»¶å·²æˆåŠŸæ¨é€åˆ°GitHub"
          else
            echo "âš ï¸ æ²¡æœ‰æ–‡ä»¶å˜åŒ–ï¼Œè·³è¿‡æäº¤"
          fi

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: proxy-results
          path: |
            subscribe/
            proxies.db
          retention-days: 5

