name: è‡ªåŠ¨æ›´æ–°ä»£ç†æ± 

on:
  schedule:
    # æ¯6å°æ—¶è¿è¡Œä¸€æ¬¡ï¼ˆæ¨èï¼‰
    - cron: '0 */6 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  update-proxies:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
      
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: ç¼“å­˜pipä¾èµ–
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: å®‰è£…ä¾èµ–
        run: |
          pip install -r requirements.txt
      
      - name: ä¸‹è½½GeoLite2æ•°æ®åº“
        run: |
          # å¦‚æœéœ€è¦GeoIPæ•°æ®åº“ï¼Œåœ¨è¿™é‡Œä¸‹è½½
          # wget -O GeoLite2-ASN.mmdb "ä½ çš„ä¸‹è½½é“¾æ¥"
          echo "è·³è¿‡GeoIPæ•°æ®åº“ä¸‹è½½"
      
      - name: è¿è¡Œä»£ç†æ‰«æå™¨
        env:
          DATABASE_PATH: proxies.db
          SCAN_TIMEOUT: 8
          MAX_CONCURRENCY: 50
        run: |
          python proxy_scanner_enhanced.py --timeout 8 --max-concurrency 50
      
      - name: ç”ŸæˆæŠ¥å‘Š
        if: always()
        run: |
          python -c "
          from proxy_database import ProxyDatabase
          db = ProxyDatabase('proxies.db')
          stats = db.get_database_stats()
          print('ğŸ“Š ä»£ç†æ± ç»Ÿè®¡:')
          print(f'æ€»ä»£ç†æ•°: {stats[\"total_proxies\"]}')
          print(f'24å°æ—¶æ´»è·ƒ: {stats[\"active_proxies_24h\"]}')
          print(f'æˆåŠŸç‡: {stats[\"success_rate_24h\"]*100:.1f}%')
          "
      
      - name: æäº¤æ›´æ–°
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add proxies.json proxies.txt proxies.csv proxies.db || true
          git diff --quiet && git diff --staged --quiet || git commit -m "è‡ªåŠ¨æ›´æ–°ä»£ç†æ±  $(date +'%Y-%m-%d %H:%M:%S')"
          git push || echo "æ²¡æœ‰æ›´æ–°éœ€è¦æ¨é€"
      
      - name: æ¸…ç†æ—§æ•°æ®
        run: |
          python -c "
          from proxy_database import ProxyDatabase
          db = ProxyDatabase('proxies.db')
          deleted_v, deleted_p = db.cleanup_old_records(days=30)
          print(f'æ¸…ç†å®Œæˆ: åˆ é™¤{deleted_v}æ¡éªŒè¯è®°å½•, {deleted_p}ä¸ªä»£ç†')
          "
      
      - name: å‘é€Telegramé€šçŸ¥
        if: failure()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d chat_id="${TELEGRAM_CHAT_ID}" \
              -d text="âš ï¸ ä»£ç†æ± æ›´æ–°å¤±è´¥ï¼è¯·æ£€æŸ¥GitHub Actionsæ—¥å¿—ã€‚"
          fi
