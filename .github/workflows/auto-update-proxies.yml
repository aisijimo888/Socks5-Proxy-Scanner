name: è‡ªåŠ¨æ›´æ–°ä»£ç†æ± 

on:
  schedule:
    # æ¯6å°æ—¶è¿è¡Œä¸€æ¬¡ï¼ˆæ¨èï¼‰
    - cron: '0 */6 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  update-proxies:
    runs-on: ubuntu-latest
    
    # å®šä¹‰ job outputs
    outputs:
      proxy-count: ${{ steps.stats.outputs.proxy-count }}
      country-count: ${{ steps.stats.outputs.country-count }}
      avg-response-time: ${{ steps.stats.outputs.avg-response-time }}
      success-rate: ${{ steps.stats.outputs.success-rate }}
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
      
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: ç¼“å­˜pipä¾èµ–
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: å®‰è£…ä¾èµ–
        run: |
          pip install -r requirements.txt
      
      - name: ä¸‹è½½GeoLite2æ•°æ®åº“
        run: |
          # å¦‚æœéœ€è¦GeoIPæ•°æ®åº“ï¼Œåœ¨è¿™é‡Œä¸‹è½½
          # wget -O GeoLite2-ASN.mmdb "ä½ çš„ä¸‹è½½é“¾æ¥"
          echo "è·³è¿‡GeoIPæ•°æ®åº“ä¸‹è½½"
      
      - name: è¿è¡Œä»£ç†æ‰«æå™¨
        env:
          DATABASE_PATH: proxies.db
          SCAN_TIMEOUT: 8
          MAX_CONCURRENCY: 50
        run: |
          python proxy_scanner_enhanced.py --timeout 8 --max-concurrency 50
      
      - name: ç”Ÿæˆè®¢é˜…æ–‡ä»¶
        run: |
          echo "ğŸ“¦ ç”Ÿæˆè®¢é˜…æ–‡ä»¶..."
          python subscription_generator.py
          echo "âœ… è®¢é˜…æ–‡ä»¶ç”Ÿæˆå®Œæˆ"
      
      - name: æ”¶é›†ç»Ÿè®¡ä¿¡æ¯
        id: stats
        run: |
          python -c "
          from proxy_database import ProxyDatabase
          import json
          
          db = ProxyDatabase('proxies.db')
          stats = db.get_database_stats()
          
          # è®¾ç½® GitHub Actions outputs
          print(f'proxy-count={stats.get(\"total_proxies\", 0)}')
          print(f'country-count={len(stats.get(\"country_distribution\", {}))}')
          print(f'avg-response-time={stats.get(\"avg_response_time_24h\", 0):.2f}')
          print(f'success-rate={stats.get(\"success_rate_24h\", 0):.1%}')
          
          # ä¿å­˜åˆ°ç¯å¢ƒå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          with open('stats.json', 'w') as f:
              json.dump(stats, f)
          " >> $GITHUB_OUTPUT
      
      - name: ç”Ÿæˆ Actions æ‘˜è¦
        if: always()
        run: |
          python -c "
          import json
          from datetime import datetime
          
          # è¯»å–ç»Ÿè®¡æ•°æ®
          try:
              with open('stats.json', 'r') as f:
                  stats = json.load(f)
          except:
              stats = {}
          
          # ç”Ÿæˆ Markdown æ‘˜è¦
          summary = f'''
          # ğŸ“Š ä»£ç†æ± æ›´æ–°æ‘˜è¦
          
          **æ›´æ–°æ—¶é—´:** {datetime.now().strftime('%Y-%m-%d %H:%M:%S UTC')}
          
          ## ğŸ“ˆ ç»Ÿè®¡ä¿¡æ¯
          
          | æŒ‡æ ‡ | æ•°å€¼ |
          |------|------|
          | âœ… æ€»ä»£ç†æ•° | {stats.get('total_proxies', 0)} |
          | ğŸ”¥ 24å°æ—¶æ´»è·ƒ | {stats.get('active_proxies_24h', 0)} |
          | ğŸŒ å›½å®¶æ•°é‡ | {len(stats.get('country_distribution', {}))} |
          | âš¡ å¹³å‡å“åº”æ—¶é—´ | {stats.get('avg_response_time_24h', 0):.2f}s |
          | ğŸ“Š æˆåŠŸç‡ | {stats.get('success_rate_24h', 0)*100:.1f}% |
          
          ## ğŸŒ å›½å®¶åˆ†å¸ƒ (Top 10)
          
          '''
          
          # æ·»åŠ å›½å®¶åˆ†å¸ƒ
          countries = stats.get('country_distribution', {})
          if countries:
              sorted_countries = sorted(countries.items(), key=lambda x: x[1], reverse=True)[:10]
              summary += '| å›½å®¶ | æ•°é‡ |\\n|------|------|\\n'
              for country, count in sorted_countries:
                  summary += f'| {country} | {count} |\\n'
          else:
              summary += '*æš‚æ— æ•°æ®*\\n'
          
          summary += '''
          
          ## ğŸ“ è®¢é˜…é“¾æ¥
          
          ç‚¹å‡»ä¸‹æ–¹é“¾æ¥è·å–æœ€æ–°ä»£ç†è®¢é˜…ï¼š
          
          - ğŸ”· [Clash è®¢é˜…](https://raw.githubusercontent.com/${{ github.repository }}/main/subscribe/clash.yaml)
          - ğŸ”¶ [V2Ray è®¢é˜…](https://raw.githubusercontent.com/${{ github.repository }}/main/subscribe/v2ray.json)
          - ğŸ”¸ [ShadowRocket è®¢é˜…](https://raw.githubusercontent.com/${{ github.repository }}/main/subscribe/shadowrocket.txt)
          - ğŸ“„ [çº¯æ–‡æœ¬åˆ—è¡¨](https://raw.githubusercontent.com/${{ github.repository }}/main/subscribe/proxies.txt)
          - ğŸ” [Base64 ç¼–ç ](https://raw.githubusercontent.com/${{ github.repository }}/main/subscribe/base64.txt)
          '''
          
          # å†™å…¥åˆ° GitHub Step Summary
          with open('$GITHUB_STEP_SUMMARY', 'w') as f:
              f.write(summary)
          
          print('âœ… Actions æ‘˜è¦å·²ç”Ÿæˆ')
          "
      
      - name: æäº¤æ›´æ–°
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add proxies.json proxies.txt proxies.csv proxies.db subscribe/ || true
          git diff --quiet && git diff --staged --quiet || git commit -m "ğŸ”„ è‡ªåŠ¨æ›´æ–°ä»£ç†æ±  $(date +'%Y-%m-%d %H:%M:%S')"
          git push || echo "æ²¡æœ‰æ›´æ–°éœ€è¦æ¨é€"
      
      - name: æ¸…ç†æ—§æ•°æ®
        run: |
          python -c "
          from proxy_database import ProxyDatabase
          db = ProxyDatabase('proxies.db')
          deleted_v, deleted_p = db.cleanup_old_records(days=30)
          print(f'æ¸…ç†å®Œæˆ: åˆ é™¤{deleted_v}æ¡éªŒè¯è®°å½•, {deleted_p}ä¸ªä»£ç†')
          "
      
      - name: å‘é€æˆåŠŸé€šçŸ¥
        if: success()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
            python -c "
          import requests
          import json
          import os
          
          try:
              with open('stats.json', 'r') as f:
                  stats = json.load(f)
          except:
              stats = {}
          
          # æ„å»ºé€šçŸ¥æ¶ˆæ¯
          message = f'''ğŸ‰ ä»£ç†æ± æ›´æ–°æˆåŠŸï¼
          
          ğŸ“Š ç»Ÿè®¡ä¿¡æ¯ï¼š
          âœ… æ€»ä»£ç†æ•°ï¼š{stats.get('total_proxies', 0)}
          ğŸ”¥ æ´»è·ƒä»£ç†ï¼š{stats.get('active_proxies_24h', 0)}
          ğŸŒ å›½å®¶æ•°é‡ï¼š{len(stats.get('country_distribution', {}))}
          âš¡ å¹³å‡å“åº”ï¼š{stats.get('avg_response_time_24h', 0):.2f}s
          ğŸ“Š æˆåŠŸç‡ï¼š{stats.get('success_rate_24h', 0)*100:.1f}%
          
          ğŸ”— è®¢é˜…é“¾æ¥ï¼š
          Clash: https://raw.githubusercontent.com/${{ github.repository }}/main/subscribe/clash.yaml
          V2Ray: https://raw.githubusercontent.com/${{ github.repository }}/main/subscribe/v2ray.json
          '''
          
          # å‘é€åˆ° Telegram
          url = f\"https://api.telegram.org/bot{os.getenv('TELEGRAM_BOT_TOKEN')}/sendMessage\"
          data = {
              'chat_id': os.getenv('TELEGRAM_CHAT_ID'),
              'text': message,
              'parse_mode': 'HTML'
          }
          
          response = requests.post(url, json=data)
          if response.status_code == 200:
              print('âœ… Telegram é€šçŸ¥å·²å‘é€')
          else:
              print(f'âŒ Telegram é€šçŸ¥å‘é€å¤±è´¥: {response.text}')
            "
          fi
      
      - name: å‘é€å¤±è´¥é€šçŸ¥
        if: failure()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d chat_id="${TELEGRAM_CHAT_ID}" \
              -d text="âš ï¸ ä»£ç†æ± æ›´æ–°å¤±è´¥ï¼è¯·æ£€æŸ¥GitHub Actionsæ—¥å¿—ï¼šhttps://github.com/${{ github.repository }}/actions"
          fi

