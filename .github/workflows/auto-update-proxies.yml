name: è‡ªåŠ¨æ›´æ–°ä»£ç†æ± 

on:
  schedule:
    # æ¯ 6 å°æ—¶è¿è¡Œä¸€æ¬¡ (00:00, 06:00, 12:00, 18:00 UTC)
    - cron: '0 */6 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

# æƒé™é…ç½®ï¼ˆå…¬å¼€ä»“åº“å¿…éœ€ï¼‰
permissions:
  contents: write
  actions: read

jobs:
  update-proxies:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
      
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: ç¼“å­˜pipä¾èµ–
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: å®‰è£…ä¾èµ–
        run: |
          pip install -r requirements.txt
      
      - name: è¿è¡Œä»£ç†æ‰«æå™¨
        env:
          DATABASE_PATH: proxies.db
          SCAN_TIMEOUT: 8
          MAX_CONCURRENCY: 150  # æå‡åˆ°150ï¼ˆæé«˜éªŒè¯é€Ÿåº¦ï¼‰
        run: |
          # åˆ›å»ºsubscribeç›®å½•ï¼ˆç¡®ä¿å­˜åœ¨ä¸”æœ‰å†™å…¥æƒé™ï¼‰
          mkdir -p subscribe
          chmod 755 subscribe
          # è¿è¡Œä¸»ç¨‹åºï¼Œå¯ç”¨é»‘åå•åŠŸèƒ½ï¼ˆä¸€æ¬¡å¤±è´¥å³æ‹‰é»‘ï¼Œ7å¤©æ¸…ç†ï¼‰
          python proxy_scanner_enhanced.py --timeout 8 --max-concurrency 150 --output subscribe/proxies.json --enable-blacklist --auto-blacklist --blacklist-threshold 1 --cleanup-days 7
      
      - name: ç”Ÿæˆè®¢é˜…æ–‡ä»¶
        run: |
          echo "ğŸ“¦ ç”Ÿæˆè®¢é˜…æ–‡ä»¶..."
          # ç¡®ä¿subscribeç›®å½•å­˜åœ¨
          ls -la subscribe/
          python subscription_generator.py
          echo "âœ… è®¢é˜…æ–‡ä»¶ç”Ÿæˆå®Œæˆ"
          
          # å¤åˆ¶ socks5-all.txt åˆ°æ ¹ç›®å½•ä½œä¸ºä¸»è®¢é˜…æ–‡ä»¶
          if [ -f subscribe/socks5-all.txt ]; then
            cp subscribe/socks5-all.txt socks5.txt
            echo "âœ… å·²ç”Ÿæˆä¸»è®¢é˜… socks5.txt ($(wc -l < socks5.txt) ä»£ç†)"
          elif [ -f subscribe/proxies.txt ]; then
            # åå¤‡æ–¹æ¡ˆï¼šå¦‚æœ socks5-all.txt ä¸å­˜åœ¨ï¼Œä½¿ç”¨ proxies.txt
            cp subscribe/proxies.txt socks5.txt
            echo "âš ï¸ ä½¿ç”¨ proxies.txt ä½œä¸ºä¸»è®¢é˜… ($(wc -l < socks5.txt) ä»£ç†)"
          fi
          
          # æ˜¾ç¤ºç”Ÿæˆçš„æ–‡ä»¶
          echo ""
          echo "ğŸ“‹ ç”Ÿæˆçš„è®¢é˜…æ–‡ä»¶åˆ—è¡¨:"
          ls -lh subscribe/*.txt 2>/dev/null || true
          ls -lh subscribe/by-country/*.txt 2>/dev/null | head -5 || true
          [ -f socks5.txt ] && echo "âœ“ æ ¹ç›®å½• socks5.txt: $(wc -l < socks5.txt) è¡Œ" || echo "âœ— socks5.txt æœªç”Ÿæˆ"
      
      - name: ç”Ÿæˆç»Ÿè®¡æ‘˜è¦
        run: |
          python -c "
          import json
          import os
          from datetime import datetime
          
          try:
              # ä» subscribe ç›®å½•è¯»å–
              if os.path.exists('subscribe/proxies.json'):
                  with open('subscribe/proxies.json', 'r', encoding='utf-8') as f:
                      data = json.load(f)
                      # å¤„ç†æ–°æ ¼å¼ï¼šåŒ…å«metadataçš„åŒ…è£…ç»“æ„
                      if isinstance(data, dict) and 'proxies' in data:
                          proxies = data['proxies']
                      elif isinstance(data, list):
                          proxies = data
                      else:
                          proxies = []
              else:
                  proxies = []
              
              total = len(proxies)
              # ç®€å•çš„å›½å®¶ç»Ÿè®¡
              countries = {}
              for p in proxies:
                  c = p.get('country', 'Unknown')
                  countries[c] = countries.get(c, 0) + 1
              
              # ç”Ÿæˆ Markdown æ‘˜è¦
              summary = f'''
              # ğŸ“Š ä»£ç†æ± æ›´æ–°æ‘˜è¦
              
              **æ›´æ–°æ—¶é—´:** {datetime.utcnow().strftime('%Y-%m-%d %H:%M:%S UTC')}
              
              ## ğŸ“ˆ ç»Ÿè®¡ä¿¡æ¯
              
              | æŒ‡æ ‡ | æ•°å€¼ |
              |------|------|
              | âœ… æ€»ä»£ç†æ•° | {total} |
              | ğŸŒ å›½å®¶æ•°é‡ | {len(countries)} |
              
              ## ğŸŒ å›½å®¶åˆ†å¸ƒ (Top 10)
              
              '''
              
              # æ·»åŠ å›½å®¶åˆ†å¸ƒ
              if countries:
                  sorted_countries = sorted(countries.items(), key=lambda x: x[1], reverse=True)[:10]
                  summary += '| å›½å®¶ | æ•°é‡ |\\n|------|------|\\n'
                  for country, count in sorted_countries:
                      summary += f'| {country} | {count} |\\n'
              else:
                  summary += '*æš‚æ— æ•°æ®*\\n'
              
              summary += '''
              
              ## ğŸ“ è®¢é˜…é“¾æ¥
              
              ç‚¹å‡»ä¸‹æ–¹é“¾æ¥è·å–æœ€æ–°ä»£ç†è®¢é˜…ï¼š
              
              - ğŸ”· [Clash è®¢é˜…](https://raw.githubusercontent.com/${{ github.repository }}/main/subscribe/clash.yaml)
              - ğŸ”¶ [V2Ray è®¢é˜…](https://raw.githubusercontent.com/${{ github.repository }}/main/subscribe/v2ray.json)
              - ğŸ“„ [çº¯æ–‡æœ¬åˆ—è¡¨](https://raw.githubusercontent.com/${{ github.repository }}/main/subscribe/proxies.txt)
              '''
              
              # å†™å…¥åˆ° GitHub Step Summary
              with open(os.environ['GITHUB_STEP_SUMMARY'], 'w', encoding='utf-8') as f:
                  f.write(summary)
              
              print('âœ… Actions æ‘˜è¦å·²ç”Ÿæˆ')
          except Exception as e:
              print(f'âŒ ç”Ÿæˆæ‘˜è¦å¤±è´¥: {e}')
          "
      
      - name: æäº¤æ›´æ–°
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # æ˜¾ç¤ºsubscribeç›®å½•å†…å®¹
          echo "ğŸ“‚ subscribeç›®å½•æ–‡ä»¶åˆ—è¡¨:"
          ls -lh subscribe/
          
          # ç›´æ¥æ·»åŠ æ•´ä¸ªsubscribeç›®å½•ã€æ•°æ®åº“æ–‡ä»¶å’Œ socks5.txt
          git add -A subscribe/
          git add -f proxies.db socks5.txt 2>/dev/null || true
          
          # æ˜¾ç¤ºå°†è¦æäº¤çš„æ–‡ä»¶
          echo ""
          echo "ğŸ“‹ å°†è¦æäº¤çš„æ–‡ä»¶:"
          git diff --staged --name-only
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶è¢«staged
          if git diff --staged --quiet; then
            echo "âš ï¸ æ²¡æœ‰æ–‡ä»¶è¢«stagedï¼Œè·³è¿‡æäº¤"
            exit 0
          fi
          
          # æäº¤
          git commit -m "ğŸ”„ è‡ªåŠ¨æ›´æ–°ä»£ç†æ±  $(date +'%Y-%m-%d %H:%M:%S')"
          
          # æ‹‰å–å¹¶æ¨é€
          git pull --rebase origin main || true
          git push
          echo "âœ… æ–‡ä»¶å·²æˆåŠŸæ¨é€åˆ°GitHub"

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: proxy-results
          path: |
            subscribe/
            proxies.db
          retention-days: 5
      
      # éƒ¨ç½²åˆ° GitHub Pages (æä¾›æ›´å¿«çš„ CDN è®¿é—®)
      - name: éƒ¨ç½²è®¢é˜…åˆ° GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        if: success()
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./subscribe
          destination_dir: subscribe
          keep_files: false
          commit_message: "ğŸ“¦ Update SOCKS5 subscription files"
      
      # åŒæ—¶éƒ¨ç½²æ ¹ç›®å½•çš„ socks5.txt
      - name: éƒ¨ç½²ä¸»è®¢é˜…æ–‡ä»¶
        uses: peaceiris/actions-gh-pages@v3
        if: success()
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./
          keep_files: true
          commit_message: "ğŸ”„ Update socks5.txt"
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'

      - name: å‘é€TelegramæˆåŠŸé€šçŸ¥
        if: success()
        run: |
          if [ -n "${{ secrets.TELEGRAM_BOT_TOKEN }}" ] && [ -n "${{ secrets.TELEGRAM_CHAT_ID }}" ]; then
            # è¯»å–ä»£ç†ç»Ÿè®¡
            TOTAL_PROXIES=$(grep -o '"total_proxies": [0-9]*' subscribe/proxies.json | grep -o '[0-9]*' | head -1 || echo "0")
            
            MESSAGE="âœ… *ä»£ç†æ± æ›´æ–°æˆåŠŸ*

ğŸ“Š ç»Ÿè®¡ä¿¡æ¯:
- æ€»ä»£ç†æ•°: ${TOTAL_PROXIES}
- æ›´æ–°æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')

ğŸ“ ç”Ÿæˆçš„æ–‡ä»¶:
$(ls -lh subscribe/ | tail -n +2 | awk '{print "- " $9 " (" $5 ")"}'  || echo "- æ–‡ä»¶åˆ—è¡¨è·å–å¤±è´¥")

ğŸ”— ä»“åº“: https://github.com/${{ github.repository }}"

            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
              -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
              -d "text=${MESSAGE}" \
              -d "parse_mode=Markdown" \
              -d "disable_web_page_preview=true"
            
            echo "âœ… Telegramé€šçŸ¥å·²å‘é€"
          else
            echo "âš ï¸ è·³è¿‡Telegramé€šçŸ¥: æœªé…ç½®TELEGRAM_BOT_TOKENæˆ–TELEGRAM_CHAT_ID"
          fi

      - name: å‘é€Telegramå¤±è´¥é€šçŸ¥
        if: failure()
        run: |
          if [ -n "${{ secrets.TELEGRAM_BOT_TOKEN }}" ] && [ -n "${{ secrets.TELEGRAM_CHAT_ID }}" ]; then
            MESSAGE="âŒ *ä»£ç†æ± æ›´æ–°å¤±è´¥*

â° æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')
ğŸ”— æŸ¥çœ‹æ—¥å¿—: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
              -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
              -d "text=${MESSAGE}" \
              -d "parse_mode=Markdown"
            
            echo "âœ… Telegramå¤±è´¥é€šçŸ¥å·²å‘é€"
          fi

