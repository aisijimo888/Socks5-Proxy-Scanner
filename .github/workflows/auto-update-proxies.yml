name: Auto Update Proxy Pool

on:
  schedule:
    # Run every 6 hours (00:00, 06:00, 12:00, 18:00 UTC)
    - cron: '0 */6 * * *'
  workflow_dispatch:  # Allow manual trigger

# Required permissions for public repositories
permissions:
  contents: write
  actions: read

jobs:
  update-proxies:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run proxy scanner
        env:
          DATABASE_PATH: proxies.db
          SCAN_TIMEOUT: 10
          MAX_CONCURRENCY: 150
        run: |
          mkdir -p subscribe
          chmod 755 subscribe
          
          echo "Starting proxy scan..."
          python proxy_scanner_enhanced.py \
            --timeout 10 \
            --max-concurrency 150 \
            --enable-blacklist \
            --auto-blacklist \
            --blacklist-threshold 1 \
            --cleanup-days 7
          
          echo "Scan completed"
      
      - name: Generate subscription files
        run: |
          echo "Generating subscription files..."
          
          # Run subscription generator from optional directory
          if [ -f optional/subscription/subscription_generator.py ]; then
            python optional/subscription/subscription_generator.py
          fi
          
          # Create main subscription file
          if [ -f subscribe/socks5-all.txt ]; then
            cp subscribe/socks5-all.txt socks5.txt
            echo "Created socks5.txt with $(wc -l < socks5.txt) proxies"
          fi
          
          # List generated files
          echo "Generated subscription files:"
          ls -lh subscribe/*.txt 2>/dev/null || echo "No txt files in subscribe/"
      
      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Add files
          git add subscribe/ socks5.txt proxies.db 2>/dev/null || true
          
          # Check if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Auto update: $(date +'%Y-%m-%d %H:%M:%S UTC')"
            git push
            echo "Changes pushed successfully"
          fi
      
      - name: Generate summary
        if: always()
        run: |
          echo "# Proxy Pool Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f subscribe/socks5-all.txt ]; then
            PROXY_COUNT=$(wc -l < subscribe/socks5-all.txt)
            echo "## Success" >> $GITHUB_STEP_SUMMARY
            echo "- Total proxies: ${PROXY_COUNT}" >> $GITHUB_STEP_SUMMARY
            echo "- Updated: $(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          else
            echo "## Status" >> $GITHUB_STEP_SUMMARY
            echo "Check logs for details" >> $GITHUB_STEP_SUMMARY
          fi
