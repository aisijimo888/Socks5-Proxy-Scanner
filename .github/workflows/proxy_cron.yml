name: ä»£ç†æ± è‡ªåŠ¨æ›´æ–°å¹¶åŒæ­¥ï¿½?Cloudflare KV

on:
  schedule:
    # ï¿½?6 å°æ—¶è¿è¡Œä¸€ï¿½?(00:00, 06:00, 12:00, 18:00 UTC)
    - cron: '0 */6 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'

# GitHub Secrets é…ç½®è¯´æ˜Žï¿½?
# éœ€è¦åœ¨ä»“åº“ Settings -> Secrets and variables -> Actions ä¸­é…ç½®ä»¥ä¸‹å˜é‡ï¼š
#
# å¿…éœ€å˜é‡ï¿½?
# - CLOUDFLARE_API_TOKEN: Cloudflare API Token (éœ€ï¿½?Workers KV:Edit æƒé™)
# - CLOUDFLARE_ACCOUNT_ID: Cloudflare è´¦æˆ· ID
#
# å¯é€‰å˜é‡ï¼ˆå¦‚æžœéœ€ï¿½?Telegram é€šçŸ¥ï¼‰ï¼š
# - TELEGRAM_BOT_TOKEN: Telegram Bot Token
# - TELEGRAM_CHAT_ID: Telegram Chat ID

jobs:
  update-proxies:
    runs-on: ubuntu-latest
    
    steps:
      # 1. æ£€å‡ºä»£ï¿½?
      - name: æ£€å‡ºä»£ï¿½?
        uses: actions/checkout@v4
      
      # 2. è®¾ç½® Python çŽ¯å¢ƒ
      - name: è®¾ç½® Python çŽ¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      # 3. å®‰è£…ä¾èµ–
      - name: å®‰è£…ä¾èµ–
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      # 4. è¿è¡Œä»£ç†æ‰«æï¿½?
      - name: è¿è¡Œä»£ç†æ‰«æï¿½?
        env:
          DATABASE_PATH: proxies.db
          SCAN_TIMEOUT: 10
          MAX_CONCURRENCY: 150
        run: |
          echo "ðŸ” å¼€å§‹æ‰«æä»£ï¿½?.."
          python proxy_scanner_enhanced.py \
            --timeout 10 \
            --max-concurrency 150 \
            --enable-blacklist \
            --auto-blacklist \
            --blacklist-threshold 1 \
            --cleanup-days 7
          
          echo "ðŸ“Š æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶..."
          ls -lh proxies.json || echo "âš ï¸ proxies.json æœªç”Ÿï¿½?
          
          # æ˜¾ç¤ºä»£ç†æ•°é‡
          if [ -f proxies.json ]; then
            PROXY_COUNT=$(python -c "import json; data=json.load(open('proxies.json')); print(data['metadata']['total'])")
            echo "ï¿½?æˆåŠŸèŽ·å– ${PROXY_COUNT} ä¸ªæœ‰æ•ˆä»£ï¿½?
          fi
      
      # 5. ä¸Šä¼ ï¿½?Cloudflare KV
      - name: ä¸Šä¼ ï¿½?Cloudflare KV
        if: success()
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "ðŸ“¤ ä¸Šä¼  proxies.json ï¿½?Cloudflare KV..."
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜ï¿½?
          if [ ! -f proxies.json ]; then
            echo "ï¿½?proxies.json ä¸å­˜åœ¨ï¼Œè·³è¿‡ä¸Šä¼ "
            exit 1
          fi
          
          # è¯»å– JSON å†…å®¹
          PROXY_DATA=$(cat proxies.json)
          
          # ä½¿ç”¨ Cloudflare API ä¸Šä¼ ï¿½?KV
          # å‡è®¾æ‚¨çš„ KV namespace ID ï¿½?PROXY_POOL_ID (éœ€è¦åœ¨ä»“åº“ Secrets ä¸­é…ï¿½?
          KV_NAMESPACE_ID="${{ secrets.KV_NAMESPACE_ID }}"
          
          curl -X PUT "https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/storage/kv/namespaces/${KV_NAMESPACE_ID}/values/current_proxies" \
            -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
            -H "Content-Type: application/json" \
            --data-binary @proxies.json
          
          echo "ï¿½?å·²ä¸Šä¼ åˆ° Cloudflare KV (é”®å: current_proxies)"
      
      # 6. å¤‡ä»½ï¿½?GitHub Artifacts
      - name: å¤‡ä»½ï¿½?Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: proxy-results-${{ github.run_number }}
          path: |
            proxies.json
            proxies.db
            scanner.log
          retention-days: 7
          if-no-files-found: warn
      
      # 7. å‘é€æˆåŠŸé€šçŸ¥ (å¯ï¿½?
      - name: å‘ï¿½?Telegram æˆåŠŸé€šçŸ¥
        if: success() && vars.TELEGRAM_BOT_TOKEN != ''
        run: |
          if [ -n "${{ secrets.TELEGRAM_BOT_TOKEN }}" ] && [ -n "${{ secrets.TELEGRAM_CHAT_ID }}" ]; then
            PROXY_COUNT=$(python -c "import json; data=json.load(open('proxies.json')); print(data['metadata']['total'])" 2>/dev/null || echo "0")
            UPDATE_TIME=$(python -c "import json; data=json.load(open('proxies.json')); print(data['metadata']['updated_at'])" 2>/dev/null || echo "Unknown")
            
            MESSAGE="ï¿½?*ä»£ç†æ± æ›´æ–°æˆï¿½?

ðŸ“Š ç»Ÿè®¡ä¿¡æ¯:
- æ€»ä»£ç†æ•°: ${PROXY_COUNT}
- æ›´æ–°æ—¶é—´: ${UPDATE_TIME}
- è¿è¡Œç¼–å·: #${{ github.run_number }}

ðŸ“¦ å·²åŒæ­¥åˆ° Cloudflare KV
ðŸ”— ä»“åº“: https://github.com/${{ github.repository }}"

            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
              -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
              -d "text=${MESSAGE}" \
              -d "parse_mode=Markdown" \
              -d "disable_web_page_preview=true"
            
            echo "ï¿½?Telegram é€šçŸ¥å·²å‘ï¿½?
          else
            echo "â„¹ï¸ è·³è¿‡ Telegram é€šçŸ¥ (æœªé…ï¿½?"
          fi
      
      # 8. å‘é€å¤±è´¥é€šçŸ¥ (å¯ï¿½?
      - name: å‘ï¿½?Telegram å¤±è´¥é€šçŸ¥
        if: failure() && vars.TELEGRAM_BOT_TOKEN != ''
        run: |
          if [ -n "${{ secrets.TELEGRAM_BOT_TOKEN }}" ] && [ -n "${{ secrets.TELEGRAM_CHAT_ID }}" ]; then
            MESSAGE="ï¿½?*ä»£ç†æ± æ›´æ–°å¤±ï¿½?

ï¿½?æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S UTC')
ðŸ”— æŸ¥çœ‹æ—¥å¿—: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
              -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
              -d "text=${MESSAGE}" \
              -d "parse_mode=Markdown"
            
            echo "ï¿½?Telegram å¤±è´¥é€šçŸ¥å·²å‘ï¿½?
          fi
      
      # 9. ç”Ÿæˆå·¥ä½œæµæ‘˜ï¿½?
      - name: ç”Ÿæˆå·¥ä½œæµæ‘˜ï¿½?
        if: always()
        run: |
          echo "# ðŸ“Š ä»£ç†æ± æ›´æ–°æ‘˜ï¿½? >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f proxies.json ]; then
            PROXY_COUNT=$(python -c "import json; data=json.load(open('proxies.json')); print(data['metadata']['total'])" 2>/dev/null || echo "0")
            UPDATE_TIME=$(python -c "import json; data=json.load(open('proxies.json')); print(data['metadata']['updated_at'])" 2>/dev/null || echo "Unknown")
            
            echo "## ï¿½?æ‰§è¡ŒæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| æŒ‡æ ‡ | æ•°ï¿½?|" >> $GITHUB_STEP_SUMMARY
            echo "|------|------|" >> $GITHUB_STEP_SUMMARY
            echo "| æ€»ä»£ç†æ•° | ${PROXY_COUNT} |" >> $GITHUB_STEP_SUMMARY
            echo "| æ›´æ–°æ—¶é—´ | ${UPDATE_TIME} |" >> $GITHUB_STEP_SUMMARY
            echo "| è¿è¡Œç¼–å· | #${{ github.run_number }} |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ï¿½?å·²åŒæ­¥åˆ° Cloudflare KV (é”®å: current_proxies)" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ï¿½?æ‰§è¡Œå¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "proxies.json æ–‡ä»¶æœªç”Ÿæˆï¼Œè¯·æŸ¥çœ‹æ—¥å¿—ï¿½? >> $GITHUB_STEP_SUMMARY
          fi
